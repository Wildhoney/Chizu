import{G as e,A as t}from"@mobily/ts-belt";import{jsx as n}from"react/jsx-runtime";import*as r from"react";import{createContext as o,useContext as i}from"react";import{immerable as s,enablePatches as c,Immer as u}from"immer";class a{static Mount=/* @__PURE__ */Symbol("chizu.action.lifecycle/Mount");static Node=/* @__PURE__ */Symbol("chizu.action.lifecycle/Node");static Unmount=/* @__PURE__ */Symbol("chizu.action.lifecycle/Unmount");static Error=/* @__PURE__ */Symbol("chizu.action.lifecycle/Error");static Update=/* @__PURE__ */Symbol("chizu.action.lifecycle/Update")}var l=/* @__PURE__ */(e=>(e.Unicast="unicast",e.Broadcast="broadcast",e))(l||{}),f=/* @__PURE__ */(e=>(e.Mounting="mounting",e.Mounted="mounted",e.Unmounting="unmounting",e.Unmounted="unmounted",e))(f||{});const d=/* @__PURE__ */Symbol("payload"),p=/* @__PURE__ */Symbol("distributed"),h=/* @__PURE__ */Symbol("actionSymbol"),m=/* @__PURE__ */Symbol("channel");var y=/* @__PURE__ */(e=>(e[e.Timedout=0]="Timedout",e[e.Supplanted=1]="Supplanted",e[e.Disallowed=2]="Disallowed",e[e.Errored=3]="Errored",e[e.Unmounted=4]="Unmounted",e))(y||{});class v extends Error{name="AbortError";constructor(e="Aborted"){super(e)}}const b={actionPrefix:"chizu.action/",distributedActionPrefix:"chizu.action/distributed/",channelPrefix:"chizu.channel/"};function g(e,t){return new Promise((n,r)=>{if(t?.aborted)return void r(new v);const o=setTimeout(n,e);t?.addEventListener("abort",()=>{clearTimeout(o),r(new v)},{once:!0})})}function w(e){return e?Boolean(e&&"symbol"!=typeof e):/* @__PURE__ */Symbol(`pk.${Date.now()}.${crypto.randomUUID()}`)}const E=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,config:b,pk:w,sleep:g,"ζ":g,"κ":w},Symbol.toStringTag,{value:"Module"})),S=(e,t=l.Unicast)=>{const n=t===l.Broadcast?/* @__PURE__ */Symbol(`${b.distributedActionPrefix}${e}`):/* @__PURE__ */Symbol(`${b.actionPrefix}${e}`),r=function(e){return{[h]:n,[d]:void 0,[m]:e,channel:e}};return Object.defineProperty(r,h,{value:n,enumerable:!1}),Object.defineProperty(r,d,{value:void 0,enumerable:!1}),t===l.Broadcast&&Object.defineProperty(r,p,{value:!0,enumerable:!1}),r};function x(t){return e.isString(t)||"symbol"==typeof t?t:(e.isObject(t)||"function"==typeof t)&&h in t?t[h]:t}function O(t){if(e.isString(t))return t.startsWith(b.distributedActionPrefix);if("symbol"==typeof t)return t.description?.startsWith(b.distributedActionPrefix)??!1;if(e.isObject(t)||"function"==typeof t){if(p in t&&t[p])return!0;if(h in t){const e=t[h];return e.description?.startsWith(b.distributedActionPrefix)??!1}}return!1}function j(t){const n=x(t),r=e.isString(n)?n:n.description??"";return r.startsWith(b.actionPrefix)&&r.slice(r.lastIndexOf("/")+1)||"unknown"}function _(t){return e.isObject(t)&&m in t&&"channel"in t}function P(e){if(e instanceof Error){if("TimeoutError"===e.name)return y.Timedout;if("AbortError"===e.name)return y.Supplanted}return y.Errored}function A(e){return e instanceof Error?e:new Error(String(e))}const M=o(void 0);function N({handler:e,children:t}){/* @__PURE__ */
return n(M.Provider,{value:e,children:t})}let k=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[e]];return t};var U=/* @__PURE__ */(e=>(e[e.Add=1]="Add",e[e.Remove=2]="Remove",e[e.Update=4]="Update",e[e.Move=8]="Move",e[e.Replace=16]="Replace",e[e.Sort=32]="Sort",e))(U||{}),C=/* @__PURE__ */(e=>(e[e.Produce=0]="Produce",e[e.Hydrate=1]="Hydrate",e))(C||{}),R=/* @__PURE__ */(e=>(e.Property="property",e.Process="process",e.Value="value",e.Operation="operation",e))(R||{});class z{[s]=!0;static keys=new Set(Object.values(R));property=null;process=null;value;operation;constructor(e,t){this.value=e,this.operation=t}assign(e,t){const n=new z(this.value,this.operation);return n.property=e,n.process=t,n}}class L{static immer=(()=>{c();const e=new u;return e.setAutoFreeze(!1),e})();static tag="κ";static id=k}function T(e,t){const n="string"==typeof t?""===t?[]:t.split("."):t;let r=e;for(const o of n){if(null==r)return;r=r[o]}return r}function H(t){if(e.isNullable(t)||B(t))return t;if(e.isArray(t))return t.map(e=>H(e));if(e.isObject(t)){const e=Object.entries(t).map(([e,t])=>[e,H(t)]);return{...Object.fromEntries(e),[L.tag]:t[L.tag]??L.id()}}return t}function $(e){if(Array.isArray(e))return e.filter(e=>L.tag in e).map(e=>e[L.tag]??"").join(",");const t=e[L.tag];if(t)return t;try{return JSON.stringify(e)}catch{return`[unserializable:${typeof e}]`}}function B(t){return e.isNullable(t)||e.isString(t)||e.isNumber(t)||e.isBoolean(t)||"symbol"==typeof t||"bigint"==typeof t}function W(t,n,r,o,i,s){return function c(u,a=n.path){if(u instanceof z){const n=T(r,a.join("."));if(Object.entries(u).filter(([e,t])=>!z.keys.has(e)&&t instanceof z).forEach(([e,t])=>c(t,a.concat(e))),B(u.value)){if(t===C.Hydrate)return u.value;const c=a.slice(0,-1),l=c.length>0?T(r,c.join(".")):r;return e.isNullable(l)||D(l,u,a.at(-1),o,i,s),n??u.value}if(t===C.Hydrate){const e=H(c(u.value,a));return D(e,u,null,o,i,s),e}const l=n??H(u.value);return D(l,u,null,o,i,s),e.isNullable(n)?l:(c(u.value,a),n)}if(e.isArray(u))return u.map((e,t)=>c(e,a.concat(t)));if(e.isObject(u)){const e=Object.entries(u).map(([e,t])=>[e,c(t,a.concat(e))]),n=Object.fromEntries(e);if(t===C.Hydrate){const e=H(n);return Object.entries(u).forEach(([t,n])=>{n instanceof z&&B(n.value)&&D(e,n,t,o,i,s)}),e}return n}return u}(n.value)}function D(e,t,n,r,o,i){const s=i(e),c=o.get(s)??[];o.set(s,[t.assign(n,r),...c])}class F{#e={};#t;#n=/* @__PURE__ */new Map;#r=/* @__PURE__ */new Set;#o=!1;constructor(e=$){this.#t=e}static pk(){return k()}static"κ"=F.pk;annotate(e,t){return new z(t,e)}"δ"=this.annotate;get model(){return this.#e}get inspect(){return function(n,r,o,i,s){function c(i){const s=i.at(-1),c=T(n(),i),u=i.slice(0,-1),a=t.isNotEmpty(u)?T(n(),u):n();return[...e.isObject(c)||e.isArray(c)?r.get(o(c))?.filter(t=>e.isNullable(t.property))??[]:[],...e.isObject(a)?r.get(o(a))?.filter(e=>e.property===s)??[]:[]]}return function e(r){return new Proxy(()=>{},{get:(o,u)=>"pending"===u?()=>!t.isEmpty(c(r)):"remaining"===u?()=>t.length(c(r)):"box"===u?()=>({value:T(n(),r),inspect:e(r)}):"is"===u?e=>c(r).some(t=>0!==(t.operation&e)):"draft"===u?()=>t.head(c(r))?.value??T(n(),r):"settled"===u?()=>new Promise(e=>{if(t.isEmpty(c(r)))return e(T(n(),r));const o=()=>{t.isEmpty(c(r))&&(s(o),e(T(n(),r)))};i(o)}):e([...r,String(u)])})}([])}(()=>this.#e,this.#n,this.#t,e=>this.#r.add(e),e=>this.#r.delete(e))}hydrate(e){return this.#o=!0,this.#i(C.Hydrate,t=>Object.assign(t,e))}produce(e){if(!this.#o)throw new Error("State must be hydrated using hydrate() before calling produce()");return this.#i(C.Produce,e)}#i(e,t){const n=/* @__PURE__ */Symbol("process"),[,r]=L.immer.produceWithPatches(this.#e,t);return this.#e=r.reduce((t,r)=>L.immer.applyPatches(t,[{...r,value:W(e,r,t,n,this.#n,this.#t)}]),this.#e),this.#e=H(this.#e),this.#s(),n}prune(e){this.#n.forEach((n,r)=>{const o=n.filter(t=>t.process!==e);t.isEmpty(o)?this.#n.delete(r):this.#n.set(r,o)}),this.#s()}#s(){this.#r.forEach(e=>e())}observe(e){const t=()=>e(this.#e);return this.#r.add(t),()=>this.#r.delete(t)}}function G(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var I,V={exports:{}};const J=/* @__PURE__ */G((I||(I=1,function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function o(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,r,i,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var c=new o(r,i||e,s),u=n?n+t:t;return e._events[u]?e._events[u].fn?e._events[u]=[e._events[u],c]:e._events[u].push(c):(e._events[u]=c,e._eventsCount++),e}function s(e,t){0===--e._eventsCount?e._events=new r:delete e._events[t]}function c(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=/* @__PURE__ */Object.create(null),(new r).__proto__||(n=!1)),c.prototype.eventNames=function(){var e,r,o=[];if(0===this._eventsCount)return o;for(r in e=this._events)t.call(e,r)&&o.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},c.prototype.listeners=function(e){var t=this._events[n?n+e:e];if(!t)return[];if(t.fn)return[t.fn];for(var r=0,o=t.length,i=new Array(o);r<o;r++)i[r]=t[r].fn;return i},c.prototype.listenerCount=function(e){var t=this._events[n?n+e:e];return t?t.fn?1:t.length:0},c.prototype.emit=function(e,t,r,o,i,s){var c=n?n+e:e;if(!this._events[c])return!1;var u,a,l=this._events[c],f=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,o),!0;case 5:return l.fn.call(l.context,t,r,o,i),!0;case 6:return l.fn.call(l.context,t,r,o,i,s),!0}for(a=1,u=new Array(f-1);a<f;a++)u[a-1]=arguments[a];l.fn.apply(l.context,u)}else{var d,p=l.length;for(a=0;a<p;a++)switch(l[a].once&&this.removeListener(e,l[a].fn,void 0,!0),f){case 1:l[a].fn.call(l[a].context);break;case 2:l[a].fn.call(l[a].context,t);break;case 3:l[a].fn.call(l[a].context,t,r);break;case 4:l[a].fn.call(l[a].context,t,r,o);break;default:if(!u)for(d=1,u=new Array(f-1);d<f;d++)u[d-1]=arguments[d];l[a].fn.apply(l[a].context,u)}}return!0},c.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},c.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},c.prototype.removeListener=function(e,t,r,o){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return s(this,i),this;var c=this._events[i];if(c.fn)c.fn!==t||o&&!c.once||r&&c.context!==r||s(this,i);else{for(var u=0,a=[],l=c.length;u<l;u++)(c[u].fn!==t||o&&!c[u].once||r&&c[u].context!==r)&&a.push(c[u]);a.length?this._events[i]=1===a.length?a[0]:a:s(this,i)}return this},c.prototype.removeAllListeners=function(e){var t;return e?this._events[t=n?n+e:e]&&s(this,t):(this._events=new r,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=n,c.EventEmitter=c,e.exports=c}(V)),V.exports)),q=r.createContext(new J);function K(){return r.useContext(q)}function Q({children:e}){const t=r.useMemo(()=>new J,[]);/* @__PURE__ */
return n(q.Provider,{value:t,children:e})}const X=r.createContext(/* @__PURE__ */new Map);function Y(){return r.useContext(X)}function Z(){const[,e]=r.useReducer(e=>e+1,0);return e}function ee({action:t,renderer:n}){const o=K(),i=Y(),s=Z(),c=r.useMemo(()=>{const e=i.get(t);if(e)return e;const n={state:new F,listeners:/* @__PURE__ */new Set};return i.set(t,n),n},[t,i]);r.useLayoutEffect(()=>{function e(e){c.state.hydrate({value:e}),c.listeners.forEach(e=>e())}return c.listeners.add(s),o.on(t,e),()=>{c.listeners.delete(s),o.off(t,e)}},[t,o,c]);const u=c.state.model?.value;return e.isNullable(u)?null:n({value:u,inspect:c.state.inspect.value})}function te({children:e}){const t=r.useMemo(()=>/* @__PURE__ */new Map,[]);/* @__PURE__ */
return n(X.Provider,{value:t,children:e})}const ne=r.createContext(/* @__PURE__ */new Set);function re({children:e}){const t=r.useMemo(()=>/* @__PURE__ */new Set,[]);/* @__PURE__ */
return n(ne.Provider,{value:t,children:e})}function oe({children:e}){/* @__PURE__ */
return n(Q,{children:/* @__PURE__ */n(te,{children:/* @__PURE__ */n(re,{children:e})})})}function ie(e){return(t,n)=>{t.actions.produce(t=>{t.model[e]=n})}}function se(n,o=()=>({})){const s=K(),c=i(M),u=r.useContext(ne),[l,d]=r.useState(n),p=Z(),h=r.useRef(null),m=r.useRef((()=>{const e=new F;return h.current=e.hydrate(n),e})()),y=function(e){const t=r.useRef(e);return r.useLayoutEffect(()=>{t.current=e},[e]),r.useMemo(()=>{return n=t,Object.keys(e).reduce((e,t)=>(Object.defineProperty(e,t,{get:()=>n.current[t],enumerable:!0}),e),{});var n},[e])}(o()),v=r.useMemo(()=>new J,[]),b=r.useRef({handlers:/* @__PURE__ */new Map}),g=r.useRef(/* @__PURE__ */new Set),w=r.useRef(f.Mounting),E=r.useCallback((e,t,n)=>{const r=new AbortController,o={controller:r,action:e,payload:t};return u.add(o),{model:l,get phase(){return w.current},task:o,data:y,tasks:u,actions:{produce(e){if(r.signal.aborted)return;const t=m.current.produce(t=>e({model:t,inspect:m.current.inspect}));d(m.current.model),n.processes.add(t),h.current&&(n.processes.add(h.current),h.current=null)},dispatch(e,t){if(r.signal.aborted)return;const n=x(e),o=_(e)?e.channel:void 0;(O(e)?s:v).emit(n,t,o)},annotate:(e,t)=>m.current.annotate(e,t)}}},[l]);r.useLayoutEffect(()=>{function t(t,n,r){return async function(o,i){const s=r();if(e.isNotNullable(i)&&e.isNotNullable(s)&&!function(e,t){for(const n of Object.keys(e))if(t[n]!==e[n])return!1;return!0}(i,s))return;const l={processes:/* @__PURE__ */new Set},f=Promise.withResolvers(),d=E(t,o,l);try{await n(d,o)}catch(h){const e=b.current.handlers.has(a.Error),n={reason:P(h),error:A(h),action:j(t),handled:e};c?.(n),e&&v.emit(a.Error,n)}finally{for(const e of u)if(e===d.task){u.delete(e);break}l.processes.forEach(e=>m.current.prune(e)),p(),f.resolve()}}}b.current.handlers.forEach((e,n)=>{for(const{getChannel:r,handler:o}of e){const e=t(n,o,r);O(n)?(s.on(n,e),v.on(n,e),g.current.add(n)):v.on(n,e)}})},[v]),function({unicast:n,distributedActions:o,phase:i,data:s}){const c=Y(),u=r.useRef(null);r.useLayoutEffect(()=>(n.emit(a.Mount),o.forEach(t=>{const r=c.get(t),o=r?.state.model?.value;e.isNullable(o)||n.emit(t,o)}),i.current=f.Mounted,()=>{i.current=f.Unmounting,n.emit(a.Unmount),i.current=f.Unmounted}),[]),r.useEffect(()=>{n.emit(a.Node)},[]),r.useLayoutEffect(()=>{if(e.isNotNullable(u.current)){const e=function(e,t){return Object.keys(t).reduce((n,r)=>e[r]!==t[r]?{...n,[r]:t[r]}:n,{})}(u.current,s);t.isNotEmpty(Object.keys(e))&&n.emit(a.Update,e)}u.current=s},[s,n])}({unicast:v,distributedActions:g.current,phase:w,data:o()});const S=r.useMemo(()=>[l,{dispatch(e,t){const n=x(e),r=_(e)?e.channel:void 0;(O(e)?s:v).emit(n,t,r)},consume:(e,t)=>r.createElement(ee,{action:x(e),renderer:t}),get inspect(){return m.current.inspect}}],[l,v]);return S.useAction=(e,t)=>{!function(e,t,n){const o=r.useEffectEvent(async(e,t)=>{if("GeneratorFunction"===n.constructor.name||"AsyncGeneratorFunction"===n.constructor.name){const r=n(e,t);for await(const e of r);}else await n(e,t)}),i=r.useEffectEvent(()=>_(t)?t.channel:void 0),s=x(t),c=e.current.handlers.get(s)??/* @__PURE__ */new Set;0===c.size&&e.current.handlers.set(s,c),c.add({getChannel:i,handler:o})}(b,e,t)},S}export{S as Action,oe as Boundary,l as Distribution,N as Error,a as Lifecycle,U as Op,U as Operation,y as Reason,F as State,ie as With,se as useActions,E as utils};
